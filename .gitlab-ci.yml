stages:
  - build
  - test
  - deploy-dockerhub

# --- VORLAGE FÃœR NODE-JOBS ---

.setup-template: &setup
  image: node:20-alpine
  cache:
    key:
      files:
        - teilzeit-ausbildungsrechner/package-lock.json
    paths:
      - teilzeit-ausbildungsrechner/node_modules/
  before_script:
    - cd teilzeit-ausbildungsrechner
    - npm install

# --- STAGE: BUILD ---

build-job:
  <<: *setup
  stage: build
  script:
    - echo "Building project with Vite..."
    - npm run build
  artifacts:
    paths:
      # KORRIGIERTER PFAD:
      - teilzeit-ausbildungsrechner/dist/

# --- STAGE: TEST ---

lint-html-job:
  <<: *setup
  stage: test
  script:
    - npm run lint:html

lint-css-job:
  <<: *setup
  stage: test
  script:
    - npm run lint:css

lint-js-job:
  <<: *setup
  stage: test
  script:
    - npm run lint:js

# --- STAGE: DOCKERHUB ---

deploy-job:
  stage: deploy-dockerhub

  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]

  dependencies:
    - build-job

  before_script:
    - mv teilzeit-ausbildungsrechner/dist ./dist
    - echo "{\"auths\":{\"https://index.docker.io/v2/\":{\"username\":\"$DOCKERHUB_USER\",\"password\":\"$DOCKERHUB_TOKEN\"}}}" > /kaniko/.docker/config.json

  script:
    - |
      echo "--- Preparing Kaniko Tags for Docker Hub ---"
      
      IMAGE_NAME="$DOCKERHUB_USER/codecobra-docker"
      
      echo "Full Image Name: $IMAGE_NAME"

      IMAGE_TAG_ARGS="--destination $IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
      LATEST_TAG_ARGS="--destination $IMAGE_NAME:latest"

      echo "--- Running Kaniko Executor ---"
      /kaniko/executor \
        --context $CI_PROJECT_DIR \
        --dockerfile $CI_PROJECT_DIR/Dockerfile \
        $IMAGE_TAG_ARGS \
        $LATEST_TAG_ARGS

  rules:
    - if: $CI_COMMIT_BRANCH #== $CI_DEFAULT_BRANCH