stages:
  - build
  - test
  - deploy-dockerhub

# --- VORLAGE FÜR NODE-JOBS ---

.setup-template: &setup
  image: node:20-alpine
  cache:
    key:
      files:
        - teilzeit-ausbildungsrechner/package-lock.json
    paths:
      - teilzeit-ausbildungsrechner/node_modules/
  before_script:
    - cd teilzeit-ausbildungsrechner
    - npm install

# --- STAGE: BUILD ---

build-job:
  <<: *setup
  stage: build
  script:
    - echo "Building project with Vite..."
    - npm run build
  artifacts:
    paths:
      - teilzeit-ausbildungsrechner/dist/

lint-html-job:
  <<: *setup
  stage: build
  script:
    - npm run lint:html

lint-css-job:
  <<: *setup
  stage: build
  script:
    - npm run lint:css

lint-js-job:
  <<: *setup
  stage: build
  script:
    - npm run lint:js

# --- STAGE: TEST ---

unit-test-job:
  <<: *setup
  stage: test
  script:
    - npm test

selenium-test-job:
  <<: *setup
  stage: test
  image: node:20
  
  dependencies:
    - build-job

  services:
    - name: selenium/standalone-chrome:4.25.0
      alias: selenium

  variables:
    SELENIUM_REMOTE_URL: "http://selenium:4444/wd/hub"
   
  script:
    - echo "Starte Vite Preview auf Port 4173..."
    - npx vite preview --host 0.0.0.0 --port 4173 &

    - echo "Warte, bis die App im Job-Container erreichbar ist..."
    - npx wait-on http://127.0.0.1:4173 --timeout 60000

    - echo "Ermittle Job-Container-IP..."
    - export HOST_IP="$(hostname -I | awk '{print $1}')"
    - echo "Job-Container-IP ist ${HOST_IP}"

    - export TZR_BASE_URL="http://$HOST_IP:4173"
    - echo "Verwende TZR_BASE_URL=${TZR_BASE_URL} für Selenium-Tests"

    - echo "Starte Selenium-Tests..."
    - npm run test:selenium:tzr
    - npm run test:selenium:lisa
    - npm run test:selenium:lukas
    - npm run test:selenium:paul
    - npm run test:selenium:marie

# --- STAGE: DOCKERHUB ---

deploy-job:
  stage: deploy-dockerhub

  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]

  dependencies:
    - build-job

  before_script:
    - mv teilzeit-ausbildungsrechner/dist ./dist
    - echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"username\":\"$DOCKERHUB_USER\",\"password\":\"$DOCKERHUB_TOKEN\"}}}" > /kaniko/.docker/config.json

  script:
    - |
      echo "--- Preparing Kaniko Tags for Docker Hub ---"
      
      IMAGE_NAME="$DOCKERHUB_USER/codecobra-docker"
      
      echo "Full Image Name: $IMAGE_NAME"

      IMAGE_TAG_ARGS="--destination $IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
      LATEST_TAG_ARGS="--destination $IMAGE_NAME:latest"

      echo "--- Running Kaniko Executor ---"
      /kaniko/executor \
        --context $CI_PROJECT_DIR \
        --dockerfile $CI_PROJECT_DIR/Dockerfile \
        $IMAGE_TAG_ARGS \
        $LATEST_TAG_ARGS

  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH